@page "/users"

@using ZooIS.Client.Services.UsersService;
@using ZooIS.Shared.Models;
@inject IUsersService UsersService
@inject NavigationManager NavigationManager

@*
@attribute [Authorize(Roles = "Admin")]
*@

<PageTitle>Users</PageTitle>

<h3>Users</h3>

@if (Loaded)
{
    <table class="table">
        <thead>
            <tr>
                <th>Name</th>
                <th>Role</th>
                <th>Created On</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            @foreach (var user in UsersService.Users)
            {
                <tr>
                    <td>@user.Username</td>
                    <td>@user.Role</td>
                    <td>@user.DateCreated</td>
                    <td><button class="btn btn-primary" @onclick="(() => ShowUser(user.Id))"><i class="oi oi-pencil"></i></button></td>
                </tr>
            }
        </tbody>
    </table>
    <div>
        <QuickGrid Items="FilteredUsers" ResizableColumns Pagination="@pagination" Class="search">
            <PropertyColumn Property="u => u.Username" Sortable="true">
                <ColumnOptions>
                    <div class="search-box">
                        <input type="search" autofocus @bind="nameFilter" @bind:event="oninput" placeholder="Username..." />
                    </div>
                </ColumnOptions>
            </PropertyColumn>
            <PropertyColumn Property="u => u.Role" Sortable="true" Class="search">
                <ColumnOptions>
                    <div class="search-box">
                        <input type="search" autofocus @bind="roleFilter" @bind:event="oninput" placeholder="User role..." />
                    </div>
                </ColumnOptions>
            </PropertyColumn>
            <PropertyColumn Property="u => u.DateCreated" Sortable="true" />
            <TemplateColumn Title="Actions">
                <button @onclick="@(() => GoToEdit(context))" class="btn btn-primary oi oi-pencil"></button>
            </TemplateColumn>
        </QuickGrid>
        <Paginator Value="@pagination" />

    </div>
    <button class="btn btn-primary" @onclick="CreateNewUser">Create a new user</button>
}
else
{
    <div class="loader">Loading...</div>
}

@code {
    PaginationState pagination = new PaginationState { ItemsPerPage = 10 };
    IQueryable<RegisteredUser>? itemsQueryable;
    string nameFilter;
    string roleFilter;

    bool Loaded = false;

    protected override async Task OnInitializedAsync()
    {
        await UsersService.GetUsers();
        itemsQueryable = UsersService.Users.AsQueryable();
        Loaded = true;
    }

    IQueryable<RegisteredUser> FilteredUsers
    {
        get
        {
            var result = itemsQueryable;

            if (!string.IsNullOrEmpty(nameFilter))
            {
                result = result.Where(u => u.Username.Contains(nameFilter, StringComparison.CurrentCultureIgnoreCase));
            }
            if (!string.IsNullOrEmpty(roleFilter))
            {
                result = result.Where(u => u.Role.Contains(roleFilter, StringComparison.CurrentCultureIgnoreCase));
            }

            return result;
        }
    }

    void ShowUser(int id)
    {
        NavigationManager.NavigateTo($"/user/{id}");
    }

    void CreateNewUser()
    {
        NavigationManager.NavigateTo("/user");
    }

    void GoToEdit(RegisteredUser u) => NavigationManager.NavigateTo($"/user/{u.Id}");
}